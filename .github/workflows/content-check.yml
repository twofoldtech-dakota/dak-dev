name: Content Check

on:
  pull_request:
    paths:
      - 'content/posts/**'
      - '.content/**'
      - 'public/images/posts/**'

jobs:
  validate:
    name: Content Validation
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci

      - name: Run content validation
        run: npm run validate:content:all -- --ci

      - name: Run image validation
        run: npm run images:validate -- --ci

      - name: Read validation report
        if: always()
        id: report
        run: |
          if [ -f .content/validation-report.json ]; then
            TOTAL=$(jq -r '.summary.total' .content/validation-report.json)
            PASSED=$(jq -r '.summary.passed' .content/validation-report.json)
            FAILED=$(jq -r '.summary.failed' .content/validation-report.json)
            WARNINGS=$(jq -r '.summary.warnings' .content/validation-report.json)
            AVG_SCORE=$(jq -r '.summary.average_score' .content/validation-report.json)
            echo "total=$TOTAL" >> $GITHUB_OUTPUT
            echo "passed=$PASSED" >> $GITHUB_OUTPUT
            echo "failed=$FAILED" >> $GITHUB_OUTPUT
            echo "warnings=$WARNINGS" >> $GITHUB_OUTPUT
            echo "avg_score=$AVG_SCORE" >> $GITHUB_OUTPUT

            # Build results table
            RESULTS_TABLE=""
            for row in $(jq -c '.results[]' .content/validation-report.json); do
              SLUG=$(echo $row | jq -r '.slug')
              TITLE=$(echo $row | jq -r '.title')
              SCORE=$(echo $row | jq -r '.score')
              ISSUES=$(echo $row | jq -r '.issueCount')
              WARNS=$(echo $row | jq -r '.warningCount')
              STATUS=$(echo $row | jq -r 'if .passed then "Pass" else "Fail" end')
              RESULTS_TABLE="${RESULTS_TABLE}| ${TITLE} | ${SCORE}/100 | ${STATUS} | ${ISSUES} | ${WARNS} |\n"
            done
            # Use a delimiter approach for multiline
            echo "results_table<<RESULTS_EOF" >> $GITHUB_OUTPUT
            echo -e "$RESULTS_TABLE" >> $GITHUB_OUTPUT
            echo "RESULTS_EOF" >> $GITHUB_OUTPUT
          fi

      - name: Post PR comment
        if: always() && steps.report.outputs.total != ''
        uses: actions/github-script@v7
        with:
          script: |
            const avgScore = parseInt('${{ steps.report.outputs.avg_score }}');
            const scoreEmoji = avgScore >= 90 ? 'ðŸŸ¢' : avgScore >= 80 ? 'ðŸŸ¡' : 'ðŸ”´';
            const body = `## ${scoreEmoji} Content Validation Report

            | Metric | Value |
            |--------|-------|
            | Posts checked | ${{ steps.report.outputs.total }} |
            | Passed | ${{ steps.report.outputs.passed }} |
            | Failed | ${{ steps.report.outputs.failed }} |
            | Warnings | ${{ steps.report.outputs.warnings }} |
            | **Average Score** | **${{ steps.report.outputs.avg_score }}/100** |

            ### Results

            | Post | Score | Status | Issues | Warnings |
            |------|-------|--------|--------|----------|
            ${{ steps.report.outputs.results_table }}

            ---
            *Generated by content-check workflow*`;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            const existing = comments.find(c => c.body?.includes('Content Validation Report'));
            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body,
              });
            }

      - name: Check score threshold
        if: always() && steps.report.outputs.avg_score != ''
        run: |
          AVG=${{ steps.report.outputs.avg_score }}
          if [ "$AVG" -lt 80 ]; then
            echo "Average score $AVG is below threshold of 80"
            exit 1
          fi
