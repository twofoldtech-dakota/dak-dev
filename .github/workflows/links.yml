name: Link Check

on:
  schedule:
    - cron: '0 12 * * 1' # Weekly on Monday at noon UTC
  pull_request:
    paths:
      - 'content/posts/**'

jobs:
  check-links:
    name: Check Links
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check links with Lychee
        id: lychee
        uses: lycheeverse/lychee-action@v2
        with:
          args: '--verbose --no-progress content/posts/*.mdx'
          fail: false

      - name: Post PR comment (on PR)
        if: github.event_name == 'pull_request' && steps.lychee.outputs.exit_code != '0'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let report = '';
            if (fs.existsSync('./lychee/out.md')) {
              report = fs.readFileSync('./lychee/out.md', 'utf8');
            }
            const body = `## Link Check Results\n\nSome links may be broken:\n\n${report}\n\n---\n*Generated by link-check workflow*`;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body,
            });

      - name: Create/update issue (on schedule)
        if: github.event_name == 'schedule' && steps.lychee.outputs.exit_code != '0'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let report = '';
            if (fs.existsSync('./lychee/out.md')) {
              report = fs.readFileSync('./lychee/out.md', 'utf8');
            }
            const title = 'Broken links detected';
            const labels = ['broken-links'];
            const body = `## Weekly Link Check Report\n\nDate: ${new Date().toISOString().split('T')[0]}\n\n${report}\n\n---\n*Auto-generated by link-check workflow*`;

            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: labels.join(','),
              state: 'open',
            });

            if (issues.length > 0) {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues[0].number,
                body,
              });
            } else {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title,
                body,
                labels,
              });
            }
